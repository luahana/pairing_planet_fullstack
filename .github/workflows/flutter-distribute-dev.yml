# Flutter Dev Distribution
# Triggers on push to dev branch
# Builds APK and IPA, distributes to Firebase App Distribution

name: Flutter Distribute Dev

on:
  push:
    branches:
      - dev
    paths:
      - 'frontend_mobile/**'
      - '.github/workflows/flutter-distribute-dev.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  distribute-android:
    name: Build and Distribute Android
    runs-on: ubuntu-latest
    environment: dev
    defaults:
      run:
        working-directory: ./frontend_mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Patch isar_flutter_libs for AGP 8.0+ compatibility
        run: |
          ISAR_MANIFEST=$(find ~/.pub-cache/hosted/pub.dev -path "*/isar_flutter_libs-*/android/src/main/AndroidManifest.xml" 2>/dev/null | head -1)
          if [ -n "$ISAR_MANIFEST" ] && [ -f "$ISAR_MANIFEST" ]; then
            echo "Patching isar_flutter_libs manifest at: $ISAR_MANIFEST"
            sed -i 's/package="[^"]*"//g' "$ISAR_MANIFEST"
          fi

      - name: Build Release APK
        run: flutter build apk --flavor dev -t lib/main_dev.dart --release

      - name: Upload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          groups: internal-testers
          file: frontend_mobile/build/app/outputs/flutter-apk/app-dev-release.apk
          releaseNotes: |
            Dev build from commit ${{ github.sha }}
            Branch: ${{ github.ref_name }}

      - name: Android Summary
        run: |
          echo "## Android Distribution" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  distribute-ios:
    name: Build and Distribute iOS
    runs-on: macos-15
    environment: dev
    defaults:
      run:
        working-directory: ./frontend_mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install Apple certificate and provisioning profile
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_DEV_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provisioning profile from secrets
          echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Extract UUID from provisioning profile and install with UUID filename
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(/usr/bin/security cms -D -i $PP_PATH))
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision
          echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV

      - name: Setup signing config
        run: |
          # Update ExportOptions with profile UUID
          sed -i '' "s|Pairing Planet Dev AdHoc|$PP_UUID|g" ios/ExportOptions-dev.plist
          cat ios/ExportOptions-dev.plist

      - name: Build Flutter iOS without signing
        run: flutter build ios -t lib/main_dev.dart --release --no-codesign

      - name: Archive with xcodebuild
        run: |
          cd ios
          xcodebuild archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath ../build/ios/archive/Runner.xcarchive \
            -sdk iphoneos \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=DFAR672Q54 \
            "PROVISIONING_PROFILE_SPECIFIER=$PP_UUID"

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath ../build/ios/archive/Runner.xcarchive \
            -exportPath ../build/ios/ipa \
            -exportOptionsPlist ExportOptions-dev.plist

      - name: Find IPA file
        run: |
          IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_ENV
          ls -la build/ios/ipa/

      - name: Upload IPA to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_IOS_DEV }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          groups: internal-testers
          file: frontend_mobile/${{ env.IPA_PATH }}
          releaseNotes: |
            Dev build from commit ${{ github.sha }}
            Branch: ${{ github.ref_name }}

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

      - name: iOS Summary
        run: |
          echo "## iOS Distribution" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** iOS" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
