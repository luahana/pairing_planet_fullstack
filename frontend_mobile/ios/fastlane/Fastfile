default_platform(:ios)

platform :ios do
  desc "Build and distribute dev IPA to Firebase"
  lane :dev do
    # Setup code signing
    setup_ci if ENV['CI']

    # Install provisioning profile
    install_provisioning_profile(
      path: ENV['PROVISIONING_PROFILE_PATH']
    ) if ENV['PROVISIONING_PROFILE_PATH']

    # Run pod install (using bundled cocoapods)
    cocoapods(
      podfile: "./Podfile",
      repo_update: true
    )

    # Build using gym directly (avoids flutter build ios ARG_MAX issues)
    # Flutter's Dart code is compiled by xcodebuild via build phases
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release-dev",
      export_method: "ad-hoc",
      export_options: {
        provisioningProfiles: {
          "com.pairingplanet.pairingplanetfrontend.dev" => ENV['PROVISIONING_PROFILE_NAME'] || "Pairing Planet Dev AdHoc"
        },
        teamID: "DFAR672Q54",
        signingStyle: "manual"
      },
      output_directory: "../build/ios/ipa",
      output_name: "PairingPlanet-dev.ipa",
      clean: true,
      skip_profile_detection: true,
      codesigning_identity: "Apple Distribution",
      xcargs: "FLUTTER_TARGET=lib/main_dev.dart FLUTTER_BUILD_MODE=release"
    )

    # Upload to Firebase App Distribution
    if ENV['FIREBASE_APP_ID_IOS_DEV']
      firebase_app_distribution(
        app: ENV['FIREBASE_APP_ID_IOS_DEV'],
        groups: "internal-testers",
        release_notes: "Dev build from CI"
      )
    end
  end
end
