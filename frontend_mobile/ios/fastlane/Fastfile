default_platform(:ios)

platform :ios do
  desc "Build and distribute dev IPA to TestFlight"
  lane :dev do
    # Setup code signing
    setup_ci if ENV['CI']

    # Setup App Store Connect API Key for TestFlight
    if ENV['APP_STORE_CONNECT_API_KEY_ID']
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: true
      )
    end

    # Install provisioning profile
    install_provisioning_profile(
      path: ENV['PROVISIONING_PROFILE_PATH']
    ) if ENV['PROVISIONING_PROFILE_PATH']

    # Configure Flutter iOS build (generates Xcode project files without building)
    Dir.chdir("..") do
      sh("flutter", "build", "ios", "--config-only", "--release", "-t", "lib/main_dev.dart", "--no-codesign")
    end

    # Run pod install
    cocoapods(
      podfile: "./Podfile",
      repo_update: true
    )

    # Build for App Store / TestFlight
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release-dev",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.pairingplanet.pairingplanetfrontend.dev" => ENV['PROVISIONING_PROFILE_NAME'] || "Pairing Planet Dev AppStore"
        },
        teamID: "DFAR672Q54",
        signingStyle: "manual"
      },
      output_directory: "../build/ios/ipa",
      output_name: "PairingPlanet-dev.ipa",
      clean: true,
      skip_profile_detection: true,
      codesigning_identity: "Apple Distribution",
      xcargs: "FLUTTER_TARGET=lib/main_dev.dart FLUTTER_BUILD_MODE=release",
      buildlog_path: "../build/ios/logs",
      verbose: true
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      changelog: "Dev build from CI"
    )
  end
end
