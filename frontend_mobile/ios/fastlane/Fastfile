default_platform(:ios)

platform :ios do
  desc "Build and distribute dev IPA to TestFlight"
  lane :dev do
    # Setup code signing
    setup_ci if ENV['CI']

    # Setup App Store Connect API Key for TestFlight
    if ENV['APP_STORE_CONNECT_API_KEY_ID']
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: true
      )
    end

    # Install provisioning profile
    install_provisioning_profile(
      path: ENV['PROVISIONING_PROFILE_PATH']
    ) if ENV['PROVISIONING_PROFILE_PATH']

    # Paths setup - Fastlane runs from ios/fastlane
    ios_dir = File.expand_path("..", Dir.pwd)  # ios
    flutter_dir = File.expand_path("..", ios_dir)  # frontend_mobile
    profile_uuid = ENV['PROVISIONING_PROFILE_NAME'] || 'Pairing Planet Dev AppStore'

    # Step 1: Build Flutter iOS app (without creating IPA)
    # This compiles Dart code and prepares the Xcode project
    sh("cd #{flutter_dir} && flutter build ios --release -t lib/main_dev.dart --no-codesign")

    # Step 2: Use gym to archive and export with proper manual signing
    build_app(
      workspace: "#{ios_dir}/Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release-dev",
      export_method: "app-store",
      export_team_id: "DFAR672Q54",
      output_directory: "#{flutter_dir}/build/ios/ipa",
      output_name: "pairing_planet_dev.ipa",
      codesigning_identity: "Apple Distribution",
      export_options: {
        provisioningProfiles: {
          "com.pairingplanet.pairingplanetfrontend.dev" => profile_uuid
        },
        signingStyle: "manual",
        teamID: "DFAR672Q54"
      },
      xcargs: "-allowProvisioningUpdates=NO CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=DFAR672Q54 PROVISIONING_PROFILE_SPECIFIER='#{profile_uuid}'"
    )

    # Step 3: Upload to TestFlight
    ipa_path = "#{flutter_dir}/build/ios/ipa/pairing_planet_dev.ipa"
    UI.user_error!("No IPA found at #{ipa_path}") unless File.exist?(ipa_path)

    upload_to_testflight(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      changelog: "Dev build from CI"
    )
  end
end
