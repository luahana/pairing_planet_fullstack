default_platform(:ios)

platform :ios do
  desc "Build and distribute dev IPA to TestFlight"
  lane :dev do
    # Setup code signing
    setup_ci if ENV['CI']

    # Setup App Store Connect API Key for TestFlight
    if ENV['APP_STORE_CONNECT_API_KEY_ID']
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: true
      )
    end

    # Install provisioning profile
    install_provisioning_profile(
      path: ENV['PROVISIONING_PROFILE_PATH']
    ) if ENV['PROVISIONING_PROFILE_PATH']

    # Paths setup - Fastlane runs from ios/fastlane
    ios_dir = File.expand_path("..", Dir.pwd)  # ios
    flutter_dir = File.expand_path("..", ios_dir)  # frontend_mobile
    profile_uuid = ENV['PROVISIONING_PROFILE_NAME'] || 'Pairing Planet Dev AppStore'

    # Generate ExportOptions plist dynamically with the correct profile UUID
    export_plist = File.join(ios_dir, "ExportOptions-generated.plist")
    plist_content = <<~PLIST
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>DFAR672Q54</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>provisioningProfiles</key>
          <dict>
              <key>com.pairingplanet.pairingplanetfrontend.dev</key>
              <string>#{profile_uuid}</string>
          </dict>
          <key>compileBitcode</key>
          <false/>
          <key>stripSwiftSymbols</key>
          <true/>
          <key>uploadSymbols</key>
          <true/>
      </dict>
      </plist>
    PLIST
    File.write(export_plist, plist_content)
    UI.message("Generated ExportOptions plist with profile: #{profile_uuid}")

    # Clean build folder to avoid "Argument list too long" error
    sh("cd #{flutter_dir} && flutter clean")

    # Build iOS app without codesigning - let Fastlane handle signing
    sh("cd #{flutter_dir} && flutter build ios --release -t lib/main_dev.dart --no-codesign")

    # Update Xcode project to use manual signing before archiving
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "#{ios_dir}/Runner.xcodeproj",
      team_id: "DFAR672Q54",
      profile_name: profile_uuid,
      code_sign_identity: "Apple Distribution"
    )

    # Archive and sign with gym - this gives Fastlane full control over signing
    gym(
      workspace: "#{ios_dir}/Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        teamID: "DFAR672Q54",
        provisioningProfiles: {
          "com.pairingplanet.pairingplanetfrontend.dev" => profile_uuid
        }
      },
      output_directory: "#{flutter_dir}/build/ios/ipa",
      output_name: "pairing_planet_dev.ipa",
      skip_build_archive: false,
      xcargs: "CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=DFAR672Q54 CODE_SIGN_IDENTITY='Apple Distribution' PROVISIONING_PROFILE_SPECIFIER='#{profile_uuid}'"
    )

    # Upload to TestFlight
    upload_to_testflight(
      ipa: "#{flutter_dir}/build/ios/ipa/pairing_planet_dev.ipa",
      skip_waiting_for_build_processing: true,
      changelog: "Dev build from CI"
    )
  end
end
