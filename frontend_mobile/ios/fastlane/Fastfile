default_platform(:ios)

platform :ios do
  desc "Build and distribute dev IPA to TestFlight"
  lane :dev do
    # Setup code signing
    setup_ci if ENV['CI']

    # Setup App Store Connect API Key for TestFlight
    if ENV['APP_STORE_CONNECT_API_KEY_ID']
      app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: true
      )
    end

    # Install provisioning profile
    install_provisioning_profile(
      path: ENV['PROVISIONING_PROFILE_PATH']
    ) if ENV['PROVISIONING_PROFILE_PATH']

    # Build Flutter IPA with signing
    # Fastlane runs from ios/fastlane, so we need to go up two levels for flutter dir
    # and one level for the export plist
    ios_dir = File.expand_path("..", Dir.pwd)  # ios
    flutter_dir = File.expand_path("..", ios_dir)  # frontend_mobile
    export_plist = File.join(ios_dir, "ExportOptions-dev.plist")

    sh("cd #{flutter_dir} && flutter build ipa --release -t lib/main_dev.dart --export-options-plist #{export_plist}")

    # Upload to TestFlight
    # Find the IPA that flutter built
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    UI.user_error!("No IPA found in build/ios/ipa/") unless ipa_path

    upload_to_testflight(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      changelog: "Dev build from CI"
    )
  end
end
